// FINANCE BUDGET REQUEST CREATION MICROSERVICE SCHEMA
// ============================================================================

generator client {
provider = "prisma-client-js"
}

datasource db {
provider = "postgresql"
url      = env("BUDGET_REQUEST_DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum budget_request_status {
PENDING
APPROVED
REJECTED
ADJUSTED
CLOSED
}

enum request_type {
REGULAR
PROJECT_BASED
URGENT
EMERGENCY
}

// ============================================================================
// BUDGET CATEGORY
// ============================================================================

model budget_category {     // must be = to expense category
id            Int                  @id @default(autoincrement())
code          String               @unique
name          String
description   String?
is_active     Boolean              @default(true)
created_at    DateTime             @default(now())
updated_at    DateTime             @updatedAt

budget_items  budget_request_item[]

@@index([code])
@@index([is_active])
}

// ============================================================================
// BUDGET REQUEST
// ============================================================================

model budget_request {
id                  Int                     @id @default(autoincrement())
request_code        String                  @unique @default(cuid())
department_id       String
department_name     String?
requested_by        String    // system-generated current user
requested_for       String?   // optional, only admins can set
request_date        DateTime                @default(now())
total_amount        Decimal                 @db.Decimal(14,2)
status              budget_request_status   @default(PENDING)
purpose             String?                 @db.Text
remarks             String?
request_type        request_type            @default(REGULAR)
pr_reference_code   String?                 // nullable link to Purchase Request if applicable

approved_by         String?
approved_at         DateTime?
rejected_by         String?
rejected_at         DateTime?
rejection_reason    String?

items               budget_request_item[]

created_at          DateTime @default(now())
updated_at          DateTime @updatedAt
is_deleted          Boolean  @default(false)

@@index([department_id])
@@index([status])
@@index([request_type])
@@index([created_at])
}

// ============================================================================
// BUDGET REQUEST ITEM
// ============================================================================

model budget_request_item {
id                  Int                 @id @default(autoincrement())
budget_request_id   Int
category_id         Int?
description         String?             @db.Text
requested_amount    Decimal             @db.Decimal(14,2)
notes               String?

pr_item_id          Int?                // optional link to purchase_request_item

budget_request      budget_request      @relation(fields: [budget_request_id], references: [id], onDelete: Cascade)
category            budget_category?    @relation(fields: [category_id], references: [id])

@@index([budget_request_id])
@@index([category_id])
@@index([pr_item_id])
}

// ============================================================================
// unified attachment management (mirror Inventory approach)
// ============================================================================
model attachment {
	id            Int      @id @default(autoincrement())
	entity_type   String   // e.g., "BUDGET_REQUEST", "PURCHASE_REQUEST", "REFUND_REPLACEMENT"
	entity_id     String   // the id or request_code of the related entity
	file_name     String
	file_type     String   // jpeg, jpg, png, pdf, docx, etc.
	file_url      String
	file_size     Int?     // in bytes
	description   String?  @db.Text

	// audit trail
	uploaded_by   String?
	created_at    DateTime @default(now())
	updated_at    DateTime @updatedAt
	is_deleted    Boolean  @default(false)

	@@index([entity_type, entity_id])
	@@index([entity_type])
	@@index([file_type])
	@@index([is_deleted])
}

// END OF FINANCE BUDGET REQUEST CREATION MICROSERVICE SCHEMA